<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>test</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #cards { display: flex; justify-content: center; margin: 20px; }
    .card {
      width: 80px; height: 120px;
      border: 2px solid black; margin: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 2em; cursor: pointer;
      background-color: white;
    }
    .selected { background-color: lightblue; }
    #submitBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>DOUBLE MINES</h1>
  <div id="cards"></div>
  <div id="result"></div>
  <button id="submitBtn" disabled>é¸æŠã‚’é€ä¿¡</button>
  <p id="status"></p>

  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>


  <script>
    const socket = io();
    const cardsDiv = document.getElementById("cards");
    const submitBtn = document.getElementById("submitBtn");
    const status = document.getElementById("status");
    const resultDiv = document.getElementById("result");

    let isLeader = false;
    let currentPassword = localStorage.getItem("gamePassword");
    let selectedCards = [];
    let cardNumbers = [];
    let round = 1;
    let myScore = 0;
    //ç›´ã—ãŸã€‚
    let opponentScore = 0;

    const scoreDiv = document.createElement("div");
    scoreDiv.id = "scoreDiv";
    scoreDiv.style.margin = "10px";
    document.body.appendChild(scoreDiv);

    function updateScoreboard() {
      scoreDiv.innerHTML = `
        <h3>ãƒ©ã‚¦ãƒ³ãƒ‰ ${round}</h3>
        <p>ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${myScore}</p>
        <p>ç›¸æ‰‹ã®ã‚¹ã‚³ã‚¢: ${opponentScore}</p>
        <p>ç¾åœ¨ã®å½¹å‰²: <strong>${isLeader ? "è¦ª" : "å­"}</strong></p>
      `;
    }
    //let currentPassword = localStorage.getItem("password");

    // ã‚²ãƒ¼ãƒ å‚åŠ 
    console.log("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ : " , currentPassword);
    //socket.emit("join_game", { password: currentPassword });
    socket.emit("join_game", { password: currentPassword });
    console.log("join game ");
    
    socket.on("role", data => {
      console.log("role å—ä¿¡ : ", data);
      console.log("éƒ¨å±‹å—ä¿¡ : ", data);
      isLeader = data.isLeader;   // True/False ãŒå¿…ãšå…¥ã‚‹ã‚ˆã†ã«ãªã‚‹
      if (isLeader) {
        status.textContent = "ã‚ãªãŸã¯é˜²è¡›å´ã§ã™ã€‚é˜²è¡›ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’2æšé¸ã‚“ã§ãã ã•ã„ã€‚";
        cardNumbers = generateCards();
        renderCards(cardNumbers);
      } else {
        status.textContent = "ã‚ãªãŸã¯æ”»æ’ƒå´ã§ã™ã€‚é˜²è¡›å´ã®é¸æŠå¾…ã¡â€¦";
      }
    });


    // å­ã«ã‚«ãƒ¼ãƒ‰ãŒé€ã‚‰ã‚Œã¦ããŸ
    socket.on("show_cards", (data) => {
      console.log("data : " , data);
      console.log("show_cards ã¾ã§");
      cardNumbers = data.cards;
      //renderCards(cardNumbers);
      renderCards(data.cards);
      status.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’2æšé¸ã‚“ã§ãã ã•ã„ã€‚";
    });

    socket.on("wait_for_parent", () => {
      cardsDiv.innerHTML = "";
      status.textContent = "é˜²è¡›å´ã®é¸æŠå¾…ã¡â€¦";
    });

    socket.on("hide_cards", () => {
      //console.log("ã‚«ãƒ¼ãƒ‰ã‚’éš ã—ãŸ");
      //document.getElementById("cards-area").style.display = "none";
    });


    // è¦ªãƒ»å­å…±é€š: é¸æŠ
    function renderCards(numbers){
      cardsDiv.innerHTML = "";
      selectedCards = [];
      numbers.forEach(num => {
        const div = document.createElement("div");
        div.classList.add("card");
        div.textContent = num;

        div.style.position = "relative"; // overlay ã®åŸºæº–

         // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»åƒã‚’ä½œæˆï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰
        const img = document.createElement("img");
        img.style.position = "absolute";
        //img.style.top = "50%";
        //img.style.left = "50%";
        img.style.width = "50%";       // ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã®åŠåˆ†
        img.style.height = "auto";
        //img.style.transform = "translate(-50%, -50%)"; // ä¸­å¤®ã«é…ç½®
        img.style.opacity = "0.7";     // åŠé€æ˜
        img.style.pointerEvents = "none"; // ã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ãªã„
        img.src = ""; // åˆæœŸã¯ç©º
        div.appendChild(img);

        div.addEventListener("click", () => toggleSelect(div, num, img));
        cardsDiv.appendChild(div);
      });
      submitBtn.disabled = true;
    }

    function toggleSelect(cardEl, num, imgEl){
      if(selectedCards.includes(num)){
        selectedCards = selectedCards.filter(n => n !== num);
        cardEl.classList.remove("selected");
        imgEl.src = ""; // ç”»åƒå‰Šé™¤
      } else {
        if(selectedCards.length < 2){
          selectedCards.push(num);
          cardEl.classList.add("selected");

         if(isLeader){
           imgEl.src = "/static/images/thunder.png";
           // å³ä¸‹ã«é…ç½®
           imgEl.style.top = "auto";
           imgEl.style.left = "auto";
            imgEl.style.bottom = "5%";
            imgEl.style.right = "5%";
            imgEl.style.transform = "none";
          } else {
            imgEl.src = "/static/images/human.png";
            // å·¦ä¸Šã«é…ç½®
            imgEl.style.top = "5%";
            imgEl.style.left = "5%";
            imgEl.style.bottom = "auto";
            imgEl.style.right = "auto";
            imgEl.style.transform = "none";
          }
        }
      }

      submitBtn.disabled = (selectedCards.length !== 2);
    }
    // é¸æŠé€ä¿¡ãƒœã‚¿ãƒ³
    
    submitBtn.addEventListener("click", () => {
      if(isLeader){
        // è¦ª â†’ è‡ªåˆ†ã®é¸æŠã¨ã‚«ãƒ¼ãƒ‰ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
        socket.emit("parent_choice", { password: currentPassword, cards: cardNumbers, chosen: selectedCards });
        status.textContent = "å­ã®é¸æŠå¾…ã¡â€¦";
        console.log("ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãŸ");

        cardsDiv.querySelectorAll(".card").forEach(card => {
        card.style.pointerEvents = "none"; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
        card.style.opacity = 0.5; // åŠé€æ˜ã«ã—ã¦è¦‹ãŸç›®ã‚‚å¤‰ãˆã‚‹
        });
        submitBtn.disabled = true; // é€ä¿¡ãƒœã‚¿ãƒ³ã‚‚ç„¡åŠ¹åŒ–
      } else {
        // å­ â†’ è‡ªåˆ†ã®é¸æŠã‚’é€ã‚‹
        const chosen = Array.from(document.querySelectorAll(".card.selected")).map(c => c.textContent);
        socket.emit("child_choice", { password: currentPassword, chosen: chosen });
        //socket.emit("child_choice", { password: currentPassword, choice: selectedCards });
        status.textContent = "è¦ªã¨å­ã®çµæœã‚’å¾…ã¡â€¦";
      }
      submitBtn.disabled = true;
    });

    socket.on("round_result", (data) => {
      const { parent_choice, child_choice, score_child, round_cards } = data;
      

      // ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’å…ˆã«ä½œæˆã—ã¦ append
      const cardsContainer = document.createElement("div");
      cardsContainer.id = "result-cards";
      cardsContainer.style.display = "flex";
      cardsContainer.style.justifyContent = "center";
      cardsContainer.style.gap = "10px";
      cardsContainer.style.flexWrap = "wrap";
      resultDiv.appendChild(cardsContainer);
      //cardsDiv.innerHTML = "";

      round_cards.forEach(num => {
        const div = document.createElement("div");
        div.classList.add("card");
        div.style.position = "relative";
        div.style.width = "80px";  // ã‚«ãƒ¼ãƒ‰å¹…
        div.style.height = "120px"; // ã‚«ãƒ¼ãƒ‰é«˜ã•
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.justifyContent = "center";
        div.style.fontSize = "24px";
        div.style.fontWeight = "bold";
        div.textContent = num;

        if(parent_choice.map(String).includes(String(num))) {
          const img = document.createElement("img");
          img.src = "/static/images/thunder.png";
          img.style.position = "absolute";
          img.style.width = "50%";
          img.style.height = "auto";
          img.style.opacity = "0.7";
          img.style.bottom = "5%";
          img.style.right = "5%";
          img.style.pointerEvents = "none";
          div.appendChild(img);
        }

        // æ”»æ’ƒå´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        if(child_choice.includes(num)) {
          const img = document.createElement("img");
          img.src = "/static/images/human.png";
          img.style.position = "absolute";
          img.style.width = "50%";
          img.style.height = "auto";
          img.style.opacity = "0.7";
          img.style.top = "5%";
          img.style.left = "5%";
          img.style.pointerEvents = "none";
          div.appendChild(img);
        }

        cardsContainer.appendChild(div);
      });

      resultDiv.innerHTML = `
        <p>é˜²è¡›å´ã®é¸ã‚“ã ã‚«ãƒ¼ãƒ‰: ${parent_choice.join(", ")}</p>
        <p>æ”»æ’ƒå´ã®é¸ã‚“ã ã‚«ãƒ¼ãƒ‰: ${child_choice.join(", ")}</p>
        <p>æ”»æ’ƒå´ã®å¾—ç‚¹: ${score_child}</p>
      `;

      console.log("æ”»æ’ƒå´ã®å¾—ç‚¹", score_child);
      console.log("é˜²è¡›å´ã®é¸æŠ", parent_choice);

      let score_parent = 0; 
      if( score_child === 0){
        score_parent = 10;
        resultDiv.innerHTML = `
        <p>é˜²è¡›å´ã®é¸ã‚“ã ã‚«ãƒ¼ãƒ‰: ${parent_choice.join(", ")}</p>
        <p>æ”»æ’ƒå´ã®é¸ã‚“ã ã‚«ãƒ¼ãƒ‰: ${child_choice.join(", ")}</p>
        <p>æ”»æ’ƒå´ã®å¾—ç‚¹: ${score_child}</p>
        <p>é˜²å¾¡å´ãƒœãƒ¼ãƒŠã‚¹: ${score_parent}</p>
      `;
      }else{
        resultDiv.innerHTML = `
        <p>é˜²è¡›å´ã®é¸ã‚“ã ã‚«ãƒ¼ãƒ‰: ${parent_choice.join(", ")}</p>
        <p>æ”»æ’ƒå´ã®é¸ã‚“ã ã‚«ãƒ¼ãƒ‰: ${child_choice.join(", ")}</p>
        <p>æ”»æ’ƒå´ã®å¾—ç‚¹: ${score_child}</p>
      `;
      }

      if (isLeader) {
        opponentScore += score_child;
        myScore += score_parent;
      } else {
        myScore += score_child;
        opponentScore += score_parent;
      }

      updateScoreboard();

      if (myScore >= 50 || opponentScore >= 50) {
        status.textContent = "ã‚²ãƒ¼ãƒ çµ‚äº†";
        resultDiv.innerHTML += `
          <h2>æœ€çµ‚çµæœ</h2>
          <p>ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${myScore}</p>
          <p>ç›¸æ‰‹ã®ã‚¹ã‚³ã‚¢: ${opponentScore}</p>
          <p>${myScore > opponentScore ? "ğŸ† ã‚ãªãŸã®å‹åˆ©ï¼" : (myScore === opponentScore ? "å¼•ãåˆ†ã‘ï¼" : "ç›¸æ‰‹ã®å‹åˆ©ï¼")}</p>
        `;
        // æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
        const nextBtn = document.getElementById("nextBtn");
        if (nextBtn) nextBtn.remove();
        return; // ã“ã‚Œä»¥ä¸Šå‡¦ç†ã—ãªã„
      }

      // âœ… è¦ªã ã‘ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³è¡¨ç¤º
      if (isLeader) {
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ â–¶";
        nextBtn.id = "nextBtn";
        document.body.appendChild(nextBtn);

        nextBtn.addEventListener("click", () => {
          socket.emit("next_round", { password: currentPassword });
          nextBtn.remove();
          resultDiv.innerHTML = "";
          round++;
          isLeader = !isLeader; // å½¹å‰²äº¤ä»£
          updateScoreboard();
        });
      } else {
        status.textContent = "é˜²è¡›å´ãŒæ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™â€¦";
      }
    });

      // ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†å¾Œã«å‘¼ã°ã‚Œã‚‹
    function nextRound() {
      round++;
      isLeader = !isLeader; // å½¹å‰²äº¤ä»£
      electedCards = [];
      resultDiv.innerHTML = "";

      if (round > 10) {
        showFinalResult();
        return;
      }

      // ã‚«ãƒ¼ãƒ‰å†ç”Ÿæˆ
      cardNumbers = generateCards();
      renderCards(cardNumbers);

      // çŠ¶æ…‹æ›´æ–°
      if (isLeader) {
        status.textContent = `ç¬¬${round}ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šã‚ãªãŸã¯é˜²è¡›å´ã§ã™ã€‚2æšé¸ã‚“ã§ãã ã•ã„ã€‚`;
      } else {
        status.textContent = `ç¬¬${round}ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šã‚ãªãŸã¯æ”»æ’ƒå´ã§ã™ã€‚é˜²è¡›å´ã®é¸æŠå¾…ã¡â€¦`;
        socket.emit("request_cards", { password: currentPassword }); // æ”»æ’ƒå´ãŒæ–°ã‚«ãƒ¼ãƒ‰è¦æ±‚
      }

      updateScoreboard();
    }

    // 10ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†å¾Œ
    function showFinalResult() {
      status.textContent = "ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸ‰";
      resultDiv.innerHTML = `
        <h2>æœ€çµ‚çµæœ</h2>
        <p>ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${myScore}</p>
        <p>ç›¸æ‰‹ã®ã‚¹ã‚³ã‚¢: ${opponentScore}</p>
        <p>${myScore > opponentScore ? "ğŸ† ã‚ãªãŸã®å‹åˆ©ï¼" : (myScore === opponentScore ? "å¼•ãåˆ†ã‘ï¼" : "ç›¸æ‰‹ã®å‹åˆ©ï¼")}</p>
      `;
    }


    // çµæœã‚’è¡¨ç¤º
    socket.on("game_result", data => {
      status.textContent = `çµæœ: é˜²è¡›å´ ${data.parent}, æ”»æ’ƒå´ ${data.child}, æ”»æ’ƒå´ã®å¾—ç‚¹: ${data.score}`;
    });

    // 1ã€œ9ã®ãƒ©ãƒ³ãƒ€ãƒ 4æšï¼ˆé‡è¤‡ãªã—ï¼‰
    function generateCards(){
      let nums = [];
      while(nums.length < 4){
        let r = Math.floor(Math.random()*9)+1;
        if(!nums.includes(r)) nums.push(r);
      }
      return nums;
    }
  </script>
</body>
</html>
