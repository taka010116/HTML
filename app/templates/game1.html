<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カードゲーム</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #cards { display: flex; justify-content: center; margin: 20px; }
    .card {
      width: 80px; height: 120px;
      border: 2px solid black; margin: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 2em; cursor: pointer;
      background-color: white;
    }
    .selected { background-color: lightblue; }
  </style>
</head>
<body>
  <h1>カードゲーム</h1>
  <div id="cards"></div>
  <button id="submitBtn" disabled>選択を送信</button>
  <p id="status"></p>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const cardsDiv = document.getElementById("cards");
    const submitBtn = document.getElementById("submitBtn");
    const status = document.getElementById("status");

    let isLeader = false;
    let currentPassword = localStorage.getItem("password"); // ロビーで保存した合言葉
    let selectedCards = [];
    let cardNumbers = [];

    // 役割をサーバーから通知
    socket.emit("join_game", { password: currentPassword });

    socket.on("role", data => {
      isLeader = data.isLeader;
      if(isLeader){
        status.textContent = "あなたは親です。カードを選んでください。";
        // 親がカードを生成して送る
        cardNumbers = generateCards();
        socket.emit("cards_generated", { password: currentPassword, cards: cardNumbers });
        renderCards(cardNumbers);
      } else {
        status.textContent = "あなたは子です。親のカード待ち…";
      }
    });

    // 親が作ったカードを受け取る
    socket.on("show_cards", data => {
      cardNumbers = data.cards;
      renderCards(cardNumbers);
      status.textContent = isLeader ? "カードを2枚選んでください" : "カードを2枚選んでください";
    });

    function renderCards(numbers){
      cardsDiv.innerHTML = "";
      numbers.forEach(num => {
        const div = document.createElement("div");
        div.classList.add("card");
        div.textContent = num;
        div.addEventListener("click", () => toggleSelect(div, num));
        cardsDiv.appendChild(div);
      });
    }

    function toggleSelect(cardEl, num){
      if(selectedCards.includes(num)){
        selectedCards = selectedCards.filter(n => n !== num);
        cardEl.classList.remove("selected");
      } else {
        if(selectedCards.length < 2){
          selectedCards.push(num);
          cardEl.classList.add("selected");
        }
      }
      submitBtn.disabled = (selectedCards.length !== 2);
    }

    submitBtn.addEventListener("click", () => {
      socket.emit("submit_choice", { password: currentPassword, choice: selectedCards });
      status.textContent = "相手の選択待ち…";
      submitBtn.disabled = true;
    });

    // 結果を表示
    socket.on("game_result", data => {
      status.textContent = `結果: 親の選択 ${data.parent}, 子の選択 ${data.child}, 子の得点: ${data.score}`;
    });

    function generateCards(){
      let nums = [];
      while(nums.length < 4){
        let r = Math.floor(Math.random()*9)+1;
        if(!nums.includes(r)) nums.push(r);
      }
      return nums;
    }
  </script>
</body>
</html>
