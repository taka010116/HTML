<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>test</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #cards { display: flex; justify-content: center; margin: 20px; }
    .card {
      width: 80px; height: 120px;
      border: 2px solid black; margin: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 2em; cursor: pointer;
      background-color: white;
    }
    .selected { background-color: lightblue; }
    #submitBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>DOUBLE MINES</h1>
  <div id="cards"></div>
  <div id="result"></div>
  <button id="submitBtn" disabled>選択を送信</button>
  <p id="status"></p>

  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>


  <script>
    const socket = io();
    const cardsDiv = document.getElementById("cards");
    const submitBtn = document.getElementById("submitBtn");
    const status = document.getElementById("status");
    const resultDiv = document.getElementById("result");

    let isLeader = false;
    let currentPassword = localStorage.getItem("gamePassword");
    let selectedCards = [];
    let cardNumbers = [];
    let round = 1;
    let myScore = 0;
    //直した。
    let opponentScore = 0;

    const scoreDiv = document.createElement("div");
    scoreDiv.id = "scoreDiv";
    scoreDiv.style.margin = "10px";
    document.body.appendChild(scoreDiv);

    function updateScoreboard() {
      scoreDiv.innerHTML = `
        <h3>ラウンド ${round}</h3>
        <p>あなたのスコア: ${myScore}</p>
        <p>相手のスコア: ${opponentScore}</p>
        <p>現在の役割: <strong>${isLeader ? "親" : "子"}</strong></p>
      `;
    }
    //let currentPassword = localStorage.getItem("password");

    // ゲーム参加
    console.log("パスワード : " , currentPassword);
    //socket.emit("join_game", { password: currentPassword });
    socket.emit("join_game", { password: currentPassword });
    console.log("join game ");
    
    socket.on("role", data => {
      console.log("role 受信 : ", data);
      console.log("部屋受信 : ", data);
      isLeader = data.isLeader;   // True/False が必ず入るようになる
      if (isLeader) {
        status.textContent = "あなたは防衛側です。防衛するカードを2枚選んでください。";
        cardNumbers = generateCards();
        renderCards(cardNumbers);
      } else {
        status.textContent = "あなたは攻撃側です。防衛側の選択待ち…";
      }
    });


    // 子にカードが送られてきた
    socket.on("show_cards", (data) => {
      console.log("data : " , data);
      console.log("show_cards まで");
      cardNumbers = data.cards;
      //renderCards(cardNumbers);
      renderCards(data.cards);
      status.textContent = "カードを2枚選んでください。";
    });

    socket.on("wait_for_parent", () => {
      cardsDiv.innerHTML = "";
      status.textContent = "防衛側の選択待ち…";
    });

    socket.on("hide_cards", () => {
      //console.log("カードを隠した");
      //document.getElementById("cards-area").style.display = "none";
    });


    // 親・子共通: 選択
    function renderCards(numbers){
      cardsDiv.innerHTML = "";
      selectedCards = [];
      numbers.forEach(num => {
        const div = document.createElement("div");
        div.classList.add("card");
        div.textContent = num;
        div.addEventListener("click", () => toggleSelect(div, num));
        cardsDiv.appendChild(div);
      });
      submitBtn.disabled = true;
    }

    function toggleSelect(cardEl, num){
      if(selectedCards.includes(num)){
        selectedCards = selectedCards.filter(n => n !== num);
        cardEl.classList.remove("selected");
      } else {
        if(selectedCards.length < 2){
          selectedCards.push(num);
          cardEl.classList.add("selected");
        }
      }
      submitBtn.disabled = (selectedCards.length !== 2);
    }

    // 選択送信ボタン
    /*
    submitBtn.addEventListener("click", () => {
      if(isLeader){
        // 親 → 自分の選択とカードをサーバーに送る
        socket.emit("parent_choice", { password: currentPassword, cards: cardNumbers, chosen: selectedCards });
        status.textContent = "子の選択待ち…";
        console.log("サーバーに送信した");

        cardsDiv.querySelectorAll(".card").forEach(card => {
        card.style.pointerEvents = "none"; // クリック無効化
        card.style.opacity = 0.5; // 半透明にして見た目も変える
        });
        submitBtn.disabled = true; // 送信ボタンも無効化
      } else {
        // 子 → 自分の選択を送る
        const chosen = Array.from(document.querySelectorAll(".card.selected")).map(c => c.textContent);
        socket.emit("child_choice", { password: currentPassword, chosen: chosen });
        //socket.emit("child_choice", { password: currentPassword, choice: selectedCards });
        status.textContent = "親と子の結果を待ち…";
      }
      submitBtn.disabled = true;
    });
    */
    /*
    socket.on("round_result", (data) => {
      const { parent_choice, child_choice, score_child } = data;
      resultDiv.innerHTML = `
        <p>防衛側の選んだカード: ${parent_choice.join(", ")}</p>
        <p>攻撃側の選んだカード: ${child_choice.join(", ")}</p>
        <p>攻撃側の得点: ${score_child}</p>
      `;

      // スコア更新
      if (isLeader) {
        opponentScore += score_child;
      } else {
        myScore += score_child;
      }

      updateScoreboard();

      // 次へボタンを追加
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "次のラウンドへ ▶";
      nextBtn.id = "nextBtn";
      document.body.appendChild(nextBtn);

      nextBtn.addEventListener("click", () => {
        nextBtn.remove();
        nextRound();
      });

      console.log("攻撃側の得点", score_child);
      console.log("防衛側の選択", parent_choice);
    });
    */

    //
    socket.on("round_result", (data) => {
      const { parent_choice, child_choice, score_child } = data;
      resultDiv.innerHTML = `
        <p>防衛側の選んだカード: ${parent_choice.join(", ")}</p>
        <p>攻撃側の選んだカード: ${child_choice.join(", ")}</p>
        <p>攻撃側の得点: ${score_child}</p>
      `;

      console.log("攻撃側の得点", score_child);
      console.log("防衛側の選択", parent_choice);


    if (isLeader) {
        opponentScore += score_child;
      } else {
        myScore += score_child;
      }

      updateScoreboard();

      // ✅ 親だけ「次へ」ボタン表示
      if (isLeader) {
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "次のラウンドへ ▶";
        nextBtn.id = "nextBtn";
        document.body.appendChild(nextBtn);

        nextBtn.addEventListener("click", () => {
          socket.emit("start_round", { password: currentPassword });
          nextBtn.remove();
          resultDiv.innerHTML = "";
          round++;
          isLeader = !isLeader; // 役割交代
          updateScoreboard();
        });
      } else {
        status.textContent = "防衛側が次のラウンドを開始します…";
      }
    });

      // ラウンド終了後に呼ばれる
    function nextRound() {
      round++;
      isLeader = !isLeader; // 役割交代
      electedCards = [];
      resultDiv.innerHTML = "";

      if (round > 10) {
        showFinalResult();
        return;
      }

      // カード再生成
      cardNumbers = generateCards();
      renderCards(cardNumbers);

      // 状態更新
      if (isLeader) {
        status.textContent = `第${round}ラウンド：あなたは防衛側です。2枚選んでください。`;
      } else {
        status.textContent = `第${round}ラウンド：あなたは攻撃側です。防衛側の選択待ち…`;
        socket.emit("request_cards", { password: currentPassword }); // 攻撃側が新カード要求
      }

      updateScoreboard();
    }

    // 10ラウンド終了後
    function showFinalResult() {
      status.textContent = "🎉 ゲーム終了 🎉";
      resultDiv.innerHTML = `
        <h2>最終結果</h2>
        <p>あなたのスコア: ${myScore}</p>
        <p>相手のスコア: ${opponentScore}</p>
        <p>${myScore > opponentScore ? "🏆 あなたの勝利！" : (myScore === opponentScore ? "引き分け！" : "相手の勝利！")}</p>
      `;
    }


    // 結果を表示
    socket.on("game_result", data => {
      status.textContent = `結果: 防衛側 ${data.parent}, 攻撃側 ${data.child}, 攻撃側の得点: ${data.score}`;
    });

    // 1〜9のランダム4枚（重複なし）
    function generateCards(){
      let nums = [];
      while(nums.length < 4){
        let r = Math.floor(Math.random()*9)+1;
        if(!nums.includes(r)) nums.push(r);
      }
      return nums;
    }
  </script>
</body>
</html>
